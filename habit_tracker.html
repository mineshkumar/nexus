<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nexus</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'San Francisco', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'sans-serif'] },
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            'bg-dark': '#000000',
                            card: '#FFFFFF',
                            'card-dark': '#1C1C1E',
                            blue: '#007AFF',
                            gray: '#8E8E93',
                            separator: '#C6C6C8',
                            'separator-dark': '#38383A'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* iOS Reset & Base */
        body {
            background-color: #F2F2F7;
            color: #000000;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: calc(83px + env(safe-area-inset-bottom));
            /* 49px tab bar + 34px padding */
        }

        .dark body {
            background-color: #000000;
            color: #FFFFFF;
        }

        /* Large Title Header */
        .ios-header {
            padding: 16px 16px 8px 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            background: transparent;
        }

        .large-title {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: Semi-Bold;
        }

        /* Inset Grouped List */
        .inset-list {
            margin: 0 16px;
            border-radius: 10px;
            overflow: hidden;
            background: #FFFFFF;
        }

        .dark .inset-list {
            background: #1C1C1E;
        }

        .list-row {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid #C6C6C8;
            transition: background 0.2s;
        }

        .dark .list-row {
            border-bottom: 0.5px solid #38383A;
        }

        .list-row:last-child {
            border-bottom: none;
        }

        .list-row:active {
            background: #E5E5EA;
        }

        .dark .list-row:active {
            background: #2C2C2E;
        }

        /* Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(49px + env(safe-area-inset-bottom));
            background: rgba(249, 249, 249, 0.94);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            z-index: 1000;
        }

        .dark .tab-bar {
            background: rgba(20, 20, 20, 0.94);
            border-top: 0.5px solid rgba(255, 255, 255, 0.15);
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
            color: #8E8E93;
            font-size: 10px;
            font-weight: 500;
            gap: 2px;
            cursor: pointer;
        }

        .tab-item.active {
            color: #007AFF;
        }

        /* Checkbox Circle */
        .check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #C7C7CC;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .check-circle.checked {
            background: #007AFF;
            border-color: #007AFF;
        }

        .dark .check-circle {
            border-color: #48484A;
        }

        .dark .check-circle.checked {
            border-color: #0A84FF;
            background: #0A84FF;
        }

        /* Modal Sheet */
        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .sheet-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 2001;
        }

        .dark .sheet {
            background: #1C1C1E;
        }

        .sheet-overlay.open .sheet {
            transform: translateY(0);
        }

        .drag-handle {
            width: 36px;
            height: 5px;
            background: #D1D1D6;
            border-radius: 3px;
            margin: -12px auto 20px auto;
        }

        .dark .drag-handle {
            background: #48484A;
        }

        /* View Transitions */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
            padding-bottom: 100px;
            /* Base padding */
        }

        .view.active {
            display: block;
        }

        /* Detail View (Slide Over) */
        #view-detail {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #F2F2F7;
            z-index: 3000;
            /* Above tabs */
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            overflow-y: auto;
            display: block;
            /* Always rendered but offscreen */
        }

        .dark #view-detail {
            background: #000000;
        }

        #view-detail.open {
            transform: translateX(0);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 4px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: 50%;
            color: #000;
        }

        .dark .cal-day {
            color: #fff;
        }

        .cal-day.header {
            font-size: 11px;
            font-weight: 600;
            color: #8E8E93;
            aspect-ratio: auto;
            height: 20px;
        }

        .cal-day.filled {
            background: #34C759;
            color: white;
            font-weight: 600;
        }

        .cal-day.empty {
            background: rgba(0, 0, 0, 0.05);
        }

        .dark .cal-day.empty {
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Mini Timeline overlay on Habits */
        .dots-row {
            display: flex;
            gap: 3px;
            margin-top: 4px;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #E5E5EA;
        }

        .dark .dot {
            background: #3A3A3C;
        }

        .dot.filled {
            background: #34C759;
        }
    </style>
    <script>
        // Check local theme
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body>

    <!-- Tab Bar -->
    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('habits')">
            <i data-lucide="check-circle-2" class="w-6 h-6"></i>
            <span>Habits</span>
        </div>
        <div class="tab-item" onclick="switchTab('journal')">
            <i data-lucide="book" class="w-6 h-6"></i>
            <span>Journal</span>
        </div>
        <div class="tab-item" onclick="switchTab('settings')">
            <i data-lucide="settings-2" class="w-6 h-6"></i>
            <span>Settings</span>
        </div>
    </nav>

    <!-- VIEW: HABITS -->
    <div id="view-habits" class="view active">
        <header class="ios-header flex justify-between items-end">
            <h1 class="large-title">Habits</h1>
            <button onclick="openAddHabit()" class="text-ios-blue text-lg p-2 active:opacity-50 transition-opacity">
                <i data-lucide="plus" class="w-7 h-7"></i>
            </button>
        </header>

        <div class="px-4 pb-2">
            <span id="status" class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Syncing...</span>
        </div>

        <div id="habitList" class="inset-list mt-2">
            <!-- Habit Rows Injected Here -->
        </div>
    </div>

    <!-- VIEW: JOURNAL (Dev Notes) -->
    <div id="view-journal" class="view">
        <header class="ios-header flex justify-between items-end">
            <h1 class="large-title">Journal</h1>
            <button onclick="openDevNoteModal()" class="text-ios-blue text-lg p-2 active:opacity-50 transition-opacity">
                <!-- iOS Compose Icon -->
                <i data-lucide="square-pen" class="w-6 h-6"></i>
            </button>
        </header>

        <div class="px-4 pb-2">
            <button onclick="copyAllNotes()" class="text-xs font-medium text-ios-blue">Copy All to Clipboard</button>
        </div>

        <div id="journalList" class="space-y-4 px-4 mt-2">
            <!-- Dev Notes Injected Here -->
        </div>
    </div>

    <!-- VIEW: SETTINGS -->
    <div id="view-settings" class="view">
        <header class="ios-header">
            <h1 class="large-title">Settings</h1>
        </header>

        <div class="inset-list mt-4">
            <div class="list-row" onclick="toggleTheme()">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-md bg-gray-500 flex items-center justify-center text-white">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </div>
                    <span class="text-base font-medium">Dark Mode</span>
                </div>
                <!-- Toggle Switch Simulation -->
                <div id="themeToggle"
                    class="w-12 h-7 bg-gray-300 dark:bg-green-500 rounded-full relative transition-colors duration-200">
                    <div
                        class="w-6 h-6 bg-white rounded-full shadow absolute top-0.5 left-0.5 transition-transform duration-200 transform dark:translate-x-5">
                    </div>
                </div>
            </div>

            <div class="list-row">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-md bg-blue-500 flex items-center justify-center text-white">
                        <i data-lucide="database" class="w-5 h-5"></i>
                    </div>
                    <span class="text-base font-medium">Sync Status</span>
                </div>
                <span id="settingsStatus" class="text-gray-500 text-sm">Checking...</span>
            </div>
        </div>

        <p class="text-center text-gray-400 text-xs mt-6">Version 1.0 (Mobile Redesign)</p>
    </div>

    <!-- VIEW: DETAIL (Push) -->
    <div id="view-detail">
        <header
            class="ios-header flex items-center gap-1 sticky top-0 bg-[#F2F2F7]/90 dark:bg-black/90 backdrop-blur-md z-10 border-b border-gray-200/50 dark:border-white/10">
            <button onclick="closeDetail()" class="flex items-center text-ios-blue text-lg p-2 -ml-2 active:opacity-50">
                <i data-lucide="chevron-left" class="w-7 h-7"></i>
                <span>Habits</span>
            </button>
        </header>

        <div class="px-4 pb-2 pt-2">
            <h1 id="detailTitle" class="large-title">Habit Name</h1>
        </div>

        <!-- Stats -->
        <h3 class="px-4 pt-4 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Statistics</h3>
        <div class="inset-list">
            <div class="list-row">
                <div class="flex items-center gap-2">
                    <i data-lucide="flame" class="w-5 h-5 text-orange-500"></i>
                    <span class="text-base font-medium">Current Streak</span>
                </div>
                <span id="detailStreak" class="text-base text-gray-500">0 days</span>
            </div>
            <div class="list-row">
                <div class="flex items-center gap-2">
                    <i data-lucide="target" class="w-5 h-5 text-blue-500"></i>
                    <span class="text-base font-medium">Total Completions</span>
                </div>
                <span id="detailTotal" class="text-base text-gray-500">0</span>
            </div>
            <div class="list-row">
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar-check" class="w-5 h-5 text-green-500"></i>
                    <span class="text-base font-medium">Consistency</span>
                </div>
                <span id="detailRate" class="text-base text-gray-500">0%</span>
            </div>
        </div>

        <!-- Calendar -->
        <h3 class="px-4 pt-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Calendar</h3>
        <div class="inset-list p-4">
            <div class="flex justify-between items-center mb-4">
                <span id="calMonth" class="font-semibold text-lg">January</span>
                <div class="flex gap-4">
                    <button onclick="changeCalMonth(-1)" class="text-ios-blue"><i data-lucide="chevron-left"
                            class="w-5 h-5"></i></button>
                    <button onclick="changeCalMonth(1)" class="text-ios-blue"><i data-lucide="chevron-right"
                            class="w-5 h-5"></i></button>
                </div>
            </div>
            <div id="detailCalendar" class="calendar-grid">
                <!-- Days injected here -->
            </div>
        </div>

        <div class="px-4 mt-8 mb-12">
            <button onclick="deleteCurrentHabit()"
                class="w-full bg-white dark:bg-[#1C1C1E] text-red-500 font-medium py-3 rounded-xl shadow-sm border border-gray-100 dark:border-[#2C2C2E] active:scale-98 transition">
                Delete Habit
            </button>
        </div>
    </div>

    <!-- MODAL: ADD HABIT -->
    <div id="sheet-habit" class="sheet-overlay">
        <div class="absolute inset-0" onclick="closeSheet('sheet-habit')"></div>
        <div class="sheet">
            <div class="drag-handle"></div>
            <div class="flex justify-between items-center mb-6">
                <button onclick="closeSheet('sheet-habit')" class="text-ios-blue font-medium">Cancel</button>
                <span class="font-semibold">New Habit</span>
                <button onclick="addHabit()" class="text-ios-blue font-bold">Add</button>
            </div>
            <div class="bg-gray-100 dark:bg-zinc-800 rounded-xl px-4 py-3 flex items-center">
                <input type="text" id="habitInput" placeholder="Name"
                    class="bg-transparent w-full text-lg outline-none placeholder-gray-400">
            </div>
            <p class="text-gray-400 text-xs mt-3 px-2">Creates a new daily habit to track.</p>
        </div>
    </div>

    <!-- MODAL: ADD NOTE -->
    <div id="sheet-note" class="sheet-overlay">
        <div class="absolute inset-0" onclick="closeSheet('sheet-note')"></div>
        <div class="sheet">
            <div class="drag-handle"></div>
            <div class="flex justify-between items-center mb-4">
                <button onclick="closeSheet('sheet-note')" class="text-ios-blue font-medium">Cancel</button>
                <span class="font-semibold">New Note</span>
                <button onclick="saveDevNote()" class="text-ios-blue font-bold">Save</button>
            </div>

            <div class="space-y-3">
                <div class="bg-gray-100 dark:bg-zinc-800 rounded-xl px-2">
                    <select id="noteType" class="bg-transparent w-full p-3 text-base outline-none dark:text-white">
                        <option value="note">üìù Note</option>
                        <option value="bug">üêõ Bug</option>
                        <option value="feature">‚ú® Feature</option>
                    </select>
                </div>
                <div class="bg-gray-100 dark:bg-zinc-800 rounded-xl p-3">
                    <textarea id="noteInput" rows="4" placeholder="What's on your mind?"
                        class="bg-transparent w-full text-base outline-none dark:text-white resize-none"></textarea>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- LOGIC ---

        // Config
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.startsWith('192.168.');
        const SUPABASE_CONFIG = isLocalhost ? {
            url: 'https://jatwmjrybucdpttbigoi.supabase.co',
            key: 'sb_publishable_egBQSs0z5JvbYe68eqt5rA_rKN31Fxz'
        } : {
            url: 'https://iqlndhxlkjmqavpllhcl.supabase.co',
            key: 'sb_publishable_sE922DO0e6S-O-K4s0c9yg_o_5p95Ji'
        };
        const supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
        console.log(`[iOS Mode] Env: ${isLocalhost ? 'DEV' : 'PROD'}`);

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');

            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            // Find the tab item (simple hack: index mapping or search text)
            // Simpler: pass `t` and adding logic? 
            // Better: loop and match text content or icon?
            // For now, re-querying by matching onclick
            // Actually, let's just re-render icons if needed, but CSS .active handles color.
            // Loop all tab items, finding the one with the correct switchTab call
            const tabs = document.querySelectorAll('.tab-item');
            if (tabName === 'habits') tabs[0].classList.add('active');
            if (tabName === 'journal') tabs[1].classList.add('active');
            if (tabName === 'settings') tabs[2].classList.add('active');

            if (tabName === 'journal') fetchDevNotes();
        }

        // Sheet Logic
        function openAddHabit() {
            document.getElementById('sheet-habit').classList.add('open');
            setTimeout(() => document.getElementById('habitInput').focus(), 100);
        }
        function openDevNoteModal() {
            document.getElementById('sheet-note').classList.add('open');
            setTimeout(() => document.getElementById('noteInput').focus(), 100);
        }
        function closeSheet(id) {
            document.getElementById(id).classList.remove('open');
            document.activeElement.blur();
        }

        // Habits Logic
        let GLOBAL_HABITS = [];

        async function fetchHabits() {
            const { data, error } = await supabaseClient.from('habits').select('*').order('order', { ascending: true });
            const statusEl = document.getElementById('status');
            const settingsStatus = document.getElementById('settingsStatus');

            if (error) {
                statusEl.innerText = 'Offline / Error';
                statusEl.classList.add('text-red-500');
                settingsStatus.innerText = 'Error';
            } else {
                GLOBAL_HABITS = data || [];
                renderHabits(GLOBAL_HABITS);
                statusEl.innerText = 'Synced';
                statusEl.classList.remove('text-red-500');
                statusEl.classList.add('text-gray-400');
                settingsStatus.innerText = 'Connected';
            }
        }

        function renderHabits(habits) {
            const list = document.getElementById('habitList');
            const today = new Date(); // Warning: using client date. Ideally use UTC or server date.

            if (habits.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm">No habits yet.<br>Tap + to start.</div>`;
                return;
            }

            list.innerHTML = habits.map(habit => {
                const startDate = habit.created_at || new Date().toISOString();
                // Calculate today indx relative to creation
                // We'll trust the integer-based completions array again.
                // We need to know "Today's index"

                // Let's approximate: 
                // dayIndex = Math.floor((now - created) / 86400000)
                const createdAt = new Date(startDate);
                const dayIndex = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));

                const isDoneToday = habit.completions.includes(dayIndex);

                // Generate last 10 dots
                let dotsHTML = '';
                for (let i = 9; i >= 0; i--) {
                    const dIdx = dayIndex - i;
                    const filled = dIdx >= 0 && habit.completions.includes(dIdx);
                    // styling: standard dot vs today dot
                    // If dIdx == dayIndex (today), maybe distinct? 
                    // Let's just keep it simple dots
                    dotsHTML += `<div class="dot ${filled ? 'filled' : ''}"></div>`;
                }

                return `
                <div class="list-row group" data-id="${habit.id}">
                    <div class="flex items-center gap-3 w-full" onclick="openDetail('${habit.id}')">
                        <!-- Icon placeholder based on name hash or fixed -->
                        <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-500 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="activity" class="w-5 h-5"></i>
                        </div>
                        <div class="flex flex-col flex-1 min-w-0">
                            <span class="font-medium text-[17px] truncate">${habit.name}</span>
                            <div class="dots-row">
                                ${dotsHTML}
                            </div>
                        </div>
                         <!-- Arrow to indicate Navigation -->
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 dark:text-gray-600"></i>
                    </div>
                    
                    <!-- Separate click area for Checkbox to avoid opening detail -->
                    <div class="pl-4 border-l border-gray-100 dark:border-gray-800 ml-2" onclick="event.stopPropagation()">
                         <div class="check-circle ${isDoneToday ? 'checked' : ''}" onclick="toggleToday('${habit.id}', ${dayIndex}, [${habit.completions}])">
                            ${isDoneToday ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Add swipe delete or long press later
            lucide.createIcons();
        }

        async function addHabit() {
            const name = document.getElementById('habitInput').value;
            if (!name) return;
            await supabaseClient.from('habits').insert([{
                name,
                completions: [],
                order: Date.now(),
                created_at: new Date().toISOString()
            }]);
            document.getElementById('habitInput').value = '';
            closeSheet('sheet-habit');
            fetchHabits();
        }

        // --- Detail View Logic ---
        let currentDetailHabit = null;
        let currentCalDate = new Date();

        function openDetail(id) {
            const habit = GLOBAL_HABITS.find(h => h.id === id);
            if (!habit) return;
            currentDetailHabit = habit;
            currentCalDate = new Date(); // Reset to today

            document.getElementById('detailTitle').innerText = habit.name;

            // Stats
            document.getElementById('detailStreak').innerText = calculateStreak(habit.completions) + ' days';
            document.getElementById('detailTotal').innerText = habit.completions.length;
            const daysSinceStart = Math.max(1, Math.floor((new Date() - new Date(habit.created_at)) / (1000 * 60 * 60 * 24)));
            const rate = Math.round((habit.completions.length / daysSinceStart) * 100);
            document.getElementById('detailRate').innerText = isNaN(rate) ? '0%' : rate + '%';

            renderCalendar();
            document.getElementById('view-detail').classList.add('open');
        }

        function closeDetail() {
            document.getElementById('view-detail').classList.remove('open');
            fetchHabits();
        }

        function calculateStreak(completions) {
            if (!completions || !completions.length) return 0;
            // Determine "today" index relative to creation
            const createdAt = new Date(currentDetailHabit.created_at);
            const todayIdx = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));

            // 1. Filter out future dates and sort descending
            const sorted = [...completions].filter(c => c <= todayIdx).sort((a, b) => b - a);
            if (sorted.length === 0) return 0;

            // 2. Check if streak is alive (today or yesterday must be present)
            const latest = sorted[0];
            if (latest < todayIdx - 1) return 0;

            // 3. Count consecutive days
            let streak = 1;
            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] === sorted[i - 1] - 1) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        function changeCalMonth(delta) {
            currentCalDate.setMonth(currentCalDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const container = document.getElementById('detailCalendar');
            container.innerHTML = '';

            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            document.getElementById('calMonth').innerText = currentCalDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Headers
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                const el = document.createElement('div');
                el.className = 'cal-day header';
                el.innerText = d;
                container.appendChild(el);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty slots
            for (let i = 0; i < firstDay; i++) {
                container.innerHTML += '<div></div>';
            }

            // Days
            const createdAt = new Date(currentDetailHabit.created_at);

            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const diffTime = date - createdAt;
                const dayIndex = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                const isFilled = dayIndex >= 0 && currentDetailHabit.completions.includes(dayIndex);
                const isFuture = date > new Date();

                const el = document.createElement('div');
                el.className = `cal-day ${isFilled ? 'filled' : 'empty'}`;
                el.innerText = i;
                if (isFuture) el.style.opacity = '0.3';

                container.appendChild(el);
            }
        }

        async function deleteCurrentHabit() {
            if (!confirm("Permanently delete this habit?")) return;
            await supabaseClient.from('habits').delete().eq('id', currentDetailHabit.id);
            closeDetail();
        }

        async function toggleToday(id, dayIdx, currentCompletions) {
            // Optimistic Update
            // Re-render handled by full fetch for now to be safe, or we manually toggle class
            let newCompletions = [...currentCompletions];
            const idx = newCompletions.indexOf(dayIdx);
            if (idx > -1) newCompletions.splice(idx, 1);
            else newCompletions.push(dayIdx);

            await supabaseClient.from('habits').update({ completions: newCompletions }).eq('id', id);
            fetchHabits();
        }

        // --- Journal Logic ---
        async function fetchDevNotes() {
            const { data, error } = await supabaseClient.from('dev_notes').select('*').order('timestamp', { ascending: false });
            if (!error) renderJournal(data || []);
        }

        function renderJournal(notes) {
            const container = document.getElementById('journalList');
            if (notes.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm">No notes.</div>`;
                return;
            }
            container.innerHTML = notes.map(note => {
                const date = new Date(note.timestamp);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString();

                let icon = 'sticky-note';
                let color = 'text-gray-500';
                if (note.type === 'bug') { icon = 'bug'; color = 'text-red-500'; }
                if (note.type === 'feature') { icon = 'sparkles'; color = 'text-amber-500'; }

                return `
                <div class="bg-white dark:bg-[#1C1C1E] p-4 rounded-xl shadow-sm border border-gray-100 dark:border-[#2C2C2E] flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                         <div class="flex items-center gap-2 ${color} font-medium text-sm uppercase tracking-wide">
                            <i data-lucide="${icon}" class="w-4 h-4"></i>
                            ${note.type}
                         </div>
                         <span class="text-xs text-gray-400">${dateStr} ${timeStr}</span>
                    </div>
                    <p class="text-[17px] leading-relaxed dark:text-gray-200 whitespace-pre-wrap">${note.text}</p>
                    <div class="flex justify-end pt-2">
                        <button onclick="deleteNote('${note.id}')" class="text-xs text-red-500 font-medium px-2 py-1 bg-red-50 dark:bg-red-900/20 rounded">Delete</button>
                    </div>
                </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function saveDevNote() {
            const text = document.getElementById('noteInput').value;
            const type = document.getElementById('noteType').value;
            if (!text) return;

            await supabaseClient.from('dev_notes').insert([{
                text,
                type,
                page: 'iOSv1',
                timestamp: new Date().toISOString()
            }]);

            document.getElementById('noteInput').value = '';
            closeSheet('sheet-note');
            fetchDevNotes();
        }

        async function deleteNote(id) {
            if (!confirm('Delete note?')) return;
            await supabaseClient.from('dev_notes').delete().eq('id', id);
            fetchDevNotes();
        }

        async function copyAllNotes() {
            const { data } = await supabaseClient.from('dev_notes').select('*');
            if (!data) return;
            const text = data.map(n => `[${n.type.toUpperCase()}] ${n.text}`).join('\n\n');
            navigator.clipboard.writeText(text);
            alert('Copied to clipboard');
        }

        // Settings Logic
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
        }

        // Init
        fetchHabits();
        lucide.createIcons();
    </script>
</body>

</html>